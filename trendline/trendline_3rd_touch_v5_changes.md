# Changes: `trendline_3rd_touch_v5.pine` vs `experiment.pine`

Short summary for reviewers.

- Origin: `experiment.pine` was generated by Minddrift (AI). I adapted and refactored it into `scripts/trendline_3rd_touch_v5.pine`.
- LLM / Copilot: I used GitHub Copilot inside VS Code (and iterative LLM assistance) to fix syntax issues, clarify debounce logic, and improve structure. Because assistance was via Copilot (in-editor) there is no external chat link to share.

Key improvements in `trendline_3rd_touch_v5.pine` (concise):

- Inputs & defaults: added explicit inputs `minPivotDist`, `maxPivots`, `showSupport`/`showResistance`, and clearer tolerance inputs (ATR vs ticks) with sensible defaults.
- Tolerance calc: central `atrVal` and `tol` computation for consistent touch testing.
- Pivot storage: uses bounded arrays for pivots (`maxPivots`) and confirms pivot index as `bar_index - rightBars`.
- Encapsulated helpers: `lineY()` and `scanLine()` helpers to compute projected price and scan historical touches/breaks, improving readability and reducing repeated code.
- Debounce logic clarified: historical touch counting uses an explicit `prevTouch` state so consecutive bars near the line count as one touch.
- No-break rule: `requireNoBreak` implemented (default `true`) to reject lines that are pierced after formation.
- Candidate selection: prefer most-recent `x2` pivot; skip pairs too close via `minPivotDist`; only candidates with exactly 2 historical touches are accepted.
- Drawing management: delete previous line/label objects before creating new ones; draw only on `barstate.islast` to avoid mid-history clutter.
- Alert de-duplication: persist a `lastSupKey` / `lastResKey` (pivot pair key) so the same pivot pair won't trigger repeated alerts on subsequent bars.
- Alert ergonomics: include both `alert()` (immediate) and `alertcondition()` (UI-based) hooks; markers (`plotshape`) show the 3rd-touch bar visually.
- Code style & Pine v5 compatibility: reorganized for clearer control flow and maintainability (helpers, clearer variable names, reduced nested duplication).

Behavioral differences to note:

- `requireNoBreak` default changed to `true` (stricter than `experiment.pine` which defaulted `false`). This reduces false positives but may be tuned by reviewers.
- Tolerance multiplier default reduced (ATR mult 0.15 vs 0.25 in `experiment.pine`) for tighter touch detection; reviewers may want to adjust.

Quick test notes:

- To verify: add `scripts/trendline_3rd_touch_v5.pine` to TradingView Pine Editor, create an alert using condition “Any alert() function call”, and use Bar Replay or the synthetic-candle test script to reproduce 2-touch → 3rd-touch flows.

If you want, I can:
- Add a `requirePivotAnchorsBeTouches` boolean to enforce that the two anchor pivots themselves must be counted as the two historical touches.
- Add an optional `test_mode` that runs the indicator against an embedded synthetic series for deterministic unit testing inside TradingView.

